#!/usr/bin/env php
<?php

declare(strict_types=1);

require_once __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\SingleCommandApplication;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputOption;
use Sokil\IdBench\Database\DatabaseInterface;
use Sokil\IdBench\Benchmark\BenchmarkInterface;
use Symfony\Component\Console\Helper\ProgressBar;

$application = new SingleCommandApplication();
$application
    ->addArgument(
        'database',
        InputArgument::REQUIRED,
        'One of "mysql", "pgsql", "mongo"'
    )
    ->addArgument(
        'benchmark',
        InputArgument::REQUIRED,
        'One of suites to run'
    )
    ->addOption(
        'iterations',
        'i',
        InputOption::VALUE_OPTIONAL,
        'Count of iterations to perform',
        10
    )
    ->addOption(
        'batchSize',
        'b',
        InputOption::VALUE_OPTIONAL,
        'Count of iterations to perform',
        1000
    )
    ->setCode(function (InputInterface $input, OutputInterface $output) {
        $databaseName = $input->getArgument('database');
        $benchmarkName = $input->getArgument('benchmark');
        $iterations = (int) $input->getOption('iterations');
        $batchSize = (int) $input->getOption('batchSize');

        // get connection DSN
        $connectionDSN = getenv(strtoupper($databaseName) . '_CONNECTION_DSN');

        // build database
        $databaseClass = '\\Sokil\\IdBench\\Database\\' . ucfirst($databaseName);
        if (!class_exists($databaseClass)) {
            throw new \InvalidArgumentException(sprintf('Database class %s not found', $databaseClass));
        }

        /** @var DatabaseInterface $database */
        $database = new $databaseClass($connectionDSN);

        // build benchmark
        $benchmarkClass = '\\Sokil\\IdBench\\Benchmark\\' . ucfirst($benchmarkName) . 'Benchmark';
        if (!class_exists($benchmarkClass)) {
            throw new \InvalidArgumentException(sprintf('Benchmark class %s not found', $benchmarkClass));
        }

        /** @var BenchmarkInterface $benchmark */
        $benchmark = new $benchmarkClass(
            $database
        );

        // create benchmark generator
        $generator = $benchmark->createGenerator(
            $iterations,
            $batchSize,
        );

        // create progress bar
        $progressBar = new ProgressBar($output, $iterations);

        // show results
        $resultFilename = $databaseName . '-' . $benchmarkName . '.csv';
        $resultFile = fopen(__DIR__ . '/../results/' . $resultFilename, 'w+');
        foreach ($generator as $resultRow) {
            pcntl_signal_dispatch();

            fputcsv(
                $resultFile,
                [
                    (1 + $resultRow['iteration']) * $batchSize,
                    $resultRow['duration'],
                    $resultRow['indexSize']
                ],
                "\t"
            );

            $progressBar->advance();
        }

        // free resources
        fclose($resultFile);
        $progressBar->finish();

        $output->writeln("");
    })
    ->run();